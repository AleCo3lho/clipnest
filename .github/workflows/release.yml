name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Get version
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

    - name: Build Go binaries
      run: |
        for os_arch in darwin/amd64 darwin/arm64 linux/amd64; do
          os="${os_arch%/*}"
          arch="${os_arch#*/}"
          echo "Building ${os}/${arch}..."
          GOOS=$os GOARCH=$arch go build -ldflags="-s -w" -o "clipnest-${os}-${arch}" ./cmd/clipnest
          GOOS=$os GOARCH=$arch go build -ldflags="-s -w" -o "clipnestd-${os}-${arch}" ./cmd/clipnestd
          tar czf "clipnest-${os}-${arch}.tar.gz" "clipnest-${os}-${arch}" "clipnestd-${os}-${arch}"
        done

    - name: Set up Swift
      uses: swift-actions/setup-swift@v3
      with:
        swift-version: "6.2"

    - name: Build Swift app
      run: |
        make app
        cd app/ClipNest/build && zip -r "${GITHUB_WORKSPACE}/ClipNest.app.zip" ClipNest.app

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          clipnest-darwin-amd64.tar.gz
          clipnest-darwin-arm64.tar.gz
          clipnest-linux-amd64.tar.gz
          ClipNest.app.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-tap:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Get version
      id: version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

    - name: Download release assets and compute SHA256
      id: hashes
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        # Source tarball (auto-generated by GitHub)
        curl -sL "https://github.com/AleCo3lho/clipnest/archive/refs/tags/v${VERSION}.tar.gz" -o source.tar.gz
        echo "source_sha256=$(sha256sum source.tar.gz | awk '{print $1}')" >> "$GITHUB_OUTPUT"
        # App zip
        curl -sL "https://github.com/AleCo3lho/clipnest/releases/download/v${VERSION}/ClipNest.app.zip" -o ClipNest.app.zip
        echo "app_sha256=$(sha256sum ClipNest.app.zip | awk '{print $1}')" >> "$GITHUB_OUTPUT"

    - name: Update Homebrew tap
      env:
        TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        SOURCE_SHA="${{ steps.hashes.outputs.source_sha256 }}"
        APP_SHA="${{ steps.hashes.outputs.app_sha256 }}"

        git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/AleCo3lho/homebrew-clipnest.git"
        cd homebrew-clipnest

        # Update formula: URL (version in path) and sha256
        sed -i 's|archive/refs/tags/v[^"]*\.tar\.gz|archive/refs/tags/v'"${VERSION}"'.tar.gz|' Formula/clipnest.rb
        sed -i 's/sha256 ".*"/sha256 "'"${SOURCE_SHA}"'"/' Formula/clipnest.rb

        # Update cask: version and sha256
        sed -i 's/version ".*"/version "'"${VERSION}"'"/' Casks/clipnest-app.rb
        sed -i 's/sha256 ".*"/sha256 "'"${APP_SHA}"'"/' Casks/clipnest-app.rb

        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        git commit -m "Update to v${VERSION}"
        git push
